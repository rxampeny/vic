<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="utf-8"/>
<title>VÃ­ctor CatalÃ  1971</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.0.0/chartjs-plugin-datalabels.min.js"></script>
<style>
#countdownBox {
    margin: 10px 0;
    padding: 8px;
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 6px;
    text-align: center;
}
#countdown {
    font-size: 0.9rem;
    font-weight: normal;
    color: #2c3e50;
    line-height: 1.4;
}
#countdown .hoy {
    font-size: 0.8rem;
    color: #666;
    font-weight: normal;
}
</style>
</head>
<body>
<div class="container">
    <h1>VÃ­ctor CatalÃ  1971</h1>
    <select id="mesSelector"></select>

    <div id="countdownBox">
      <div id="countdown"></div>
    </div>

    <div id="chartContainer">
        <canvas id="aniversarisChart"></canvas>
    </div>
</div>
<script>
let dadesAniversaris = [];

// Utils
function getMesName(mesNumber) {
    const mesos = ["", "Gener", "Febrer", "MarÃ§", "Abril", "Maig", "Juny", "Juliol", "Agost", "Setembre", "Octubre", "Novembre", "Desembre"];
    return mesos[parseInt(mesNumber)] || 'Mes desconegut';
}
function getPrefixForName(nom) {
    const primeraLletra = nom.charAt(0).toLowerCase();
    return ['a','e','i','o','u','Ã ','Ã¨','Ã©','Ã­','Ã²','Ã³','Ãº'].includes(primeraLletra) ? "d'" : "de ";
}
function joinNamesCatalan(noms) {
    if (noms.length === 1) return noms[0];
    if (noms.length === 2) return `${noms[0]} i ${noms[1]}`;
    return noms.slice(0, -1).join(", ") + " i " + noms[noms.length - 1];
}
function getFormattedToday() {
    const hoy = new Date();
    const dia = hoy.getDate();
    const mes = getMesName(hoy.getMonth() + 1);
    return `${dia} ${mes}`;
}
function getNextBirthdays() {
    const today = new Date();
    const currentYear = today.getFullYear();
    const proxims = dadesAniversaris.map(d => {
        const cumple = new Date(currentYear, d.mes - 1, d.dia);
        const fecha = (cumple < today) ? new Date(currentYear + 1, d.mes - 1, d.dia) : cumple;
        return { nom: d.nom, dia: d.dia, mes: d.mes, fecha };
    }).sort((a, b) => a.fecha - b.fecha);
    return proxims.slice(0, 2);
}

// Countdown
function startCountdown() {
    const countdownEl = document.getElementById('countdown');
    if (!countdownEl) return;
    let [nextBday, secondBday] = getNextBirthdays();

    function updateCountdown() {
        [nextBday, secondBday] = getNextBirthdays();
        const now = new Date();
        const hoyTexto = getFormattedToday();
        const diff = nextBday ? (nextBday.fecha - now) : 0;

        // cumpleaÃ±eros de hoy
        const cumpleHoy = dadesAniversaris.filter(d => d.dia === now.getDate() && d.mes === (now.getMonth() + 1));
        let hoyMsg = `<span class="hoy">ðŸ“… Avui Ã©s <strong>${hoyTexto}</strong></span>`;
        if (cumpleHoy.length > 0) {
            const noms = cumpleHoy.map(d => d.nom);
            const nomsFormatats = joinNamesCatalan(noms);
            hoyMsg += `<br>ðŸŽ‚ Avui Ã©s lâ€™aniversari ${getPrefixForName(noms[0])}<strong>${nomsFormatats}</strong>`;
        }

        if (!nextBday) {
            countdownEl.innerHTML = hoyMsg;
            return;
        }

        if (diff <= 0) {
            countdownEl.innerHTML = hoyMsg + `<br><br>ðŸŽ‰ Avui Ã©s l'aniversari de ${nextBday.nom}!`;
            return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        const secondLine = secondBday ? `<br><br>ðŸ‘‰ SegÃ¼ent aniversari: <strong>${secondBday.nom}</strong> (${secondBday.dia} ${getMesName(secondBday.mes)})` : "";

        countdownEl.innerHTML = `
            ${hoyMsg}<br><br>
            ðŸŽ‰ PrÃ²xim aniversari: <strong>${nextBday.nom}</strong> (${nextBday.dia} ${getMesName(nextBday.mes)})<br>
            â³ Falten ${days} dies, ${hours}h ${minutes}m ${seconds}s
            ${secondLine}
        `;
    }

    updateCountdown();
    setInterval(updateCountdown, 1000);
}

// Inicializar
document.addEventListener('DOMContentLoaded', () => {
    fetch('aniversaris.json')
        .then(r => r.json())
        .then(data => {
            dadesAniversaris = data;
            startCountdown();
        });
});
</script>
</body>
</html>
